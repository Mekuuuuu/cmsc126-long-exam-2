{% extends "auth1_app/base.html" %}
{% load static %}
{% load humanize %}


{% block title %}Home{% endblock %}
{% block page_title %}Home{% endblock %}

<!DOCTYPE html>
<html lang="en">

{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="{% static 'css/homestyle.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Geist:wght@400;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

    <div class="top-bar">
        <div class="container topbar-content">
            <p>Welcome, <strong>{{ request.user.first_name }} {{ request.user.last_name }}!</strong></p>
            <div class="container-totalbalance">
                <p>Total Balance: â‚±{{ total_balance|floatformat:2|intcomma }}</p>
            </div>
        </div>
    </div>
    <!-- Charts -->
    <!--Test Charts-->
    <!-- Chart Section -->



    <div class="main-content">
        <div class="left-image">
            <div class="transactions-header">
                <h2>Income vs Expenses</h2>
            </div>

            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>

            <div class="filter-dropdown">
                <select id="timeFilter">
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>

            <script>
                const canvas = document.getElementById('myChart');
                const container = canvas.parentElement;

                const chartData = {
                    monthly: {
                        labels: ['January', 'February', 'March', 'April', 'May', 'June'],
                        income: [12, 19, 3, 5, 2, 3],
                        expense: [10, 15, 8, 4, 1, 2]
                    },
                    weekly: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        income: [100, 150, 80, 120],
                        expense: [90, 120, 70, 110]
                    },
                    yearly: {
                        labels: ['2020', '2021', '2022', '2023', '2024'],
                        income: [1000, 1500, 1100, 1300, 1400],
                        expense: [900, 1300, 950, 1200, 1250]
                    }
                };

                // Initial chart setup
                let chart = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: chartData.monthly.labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: chartData.monthly.income,
                                backgroundColor: '#2BB32A'
                            },
                            {
                                label: 'Expense',
                                data: chartData.monthly.expense,
                                backgroundColor: '#E53935'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: false },
                            y: { beginAtZero: true },
                        }
                    }
                });

                // Handle dropdown change
                document.getElementById('timeFilter').addEventListener('change', function () {
                    const selected = this.value;
                    chart.data.labels = chartData[selected].labels;
                    chart.data.datasets[0].data = chartData[selected].income;
                    chart.data.datasets[1].data = chartData[selected].expense;
                    chart.update();
                });
            </script>


            <script id="labels" type="application/json">
                {{ labels|json_script }}
            </script>
            <script id="income_totals" type="application/json">
                {{ income_totals|json_script }}
            </script>
            <script id="expense_totals" type="application/json">
                {{ expense_totals|json_script }}
            </script>
        </div>
        <div class="right-table">
            <div class="transactions-header">
                <h2>Recent Transactions</h2>
                <button id="openModalBtn">+ Add Transaction</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Transaction</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>
                            <strong>{{ transaction.name }}</strong> / {{ transaction.category.name }}
                        </td>
                        <td class="{% if transaction.type == 'income' %}income{% else %}expense{% endif %}">
                            {% if transaction.type == 'income' %}+ {% else %}- {% endif %}
                            {{ transaction.amount|floatformat:2|intcomma }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2">No transactions found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if transactions %}
            <div class="button-wrapper">
                <a href="{% url 'transactions' %}" class="button-link">See all transactions</a>
            </div>
            {% endif %}
        </div>

        <div id="transactionModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Add New Transaction</h3>
                <form method="POST" action="{% url 'add_transaction' %}">
                    {% csrf_token %}

                    <label>Name:</label>
                    <input type="text" name="name" required>

                    <label>Type:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="income" name="type" value="income" required checked>
                            <label for="income">Income</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="expense" name="type" value="expense">
                            <label for="expense">Expense</label>
                        </div>
                    </div>

                    <label>Date and Time:</label>
                    <input type="datetime-local" name="datetime" id="datetimeInput" required>

                    <label>Amount:</label>
                    <input type="number" name="amount" step="0.01" required>

                    <label>Category:</label>
                    <select name="category" id="categorySelect" required>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" data-type="{{ cat.type }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" id="addCategoryBtn">Add New Category</button>

                    <label>Description:</label>
                    <textarea name="description" rows="2"></textarea>

                    <div class="form-actions">
                        <button type="submit">Save</button>
                        <button type="button" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="categoryModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Add New Category</h3>
            <form id="addCategoryForm" method="POST" action="{% url 'add_category' %}">
                {% csrf_token %}
                <label>Category Name:</label>
                <input type="text" name="name" required>

                <label>Type:</label>
                <select name="type" required>
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                </select>

                <div class="form-actions">
                    <button type="submit">Create Category</button>
                    <button type="button" onclick="closeCategoryModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById("transactionModal");
        const categoryModal = document.getElementById("categoryModal");
        const datetimeInput = document.getElementById("datetimeInput");
        const typeRadios = document.querySelectorAll('input[name="type"]');

        document.getElementById("openModalBtn").onclick = () => {
            modal.style.display = "block";
            const now = new Date();
            const offset = now.getTimezoneOffset();
            const localDateTime = new Date(now.getTime() - offset * 60 * 1000).toISOString().slice(0, 16);
            datetimeInput.value = localDateTime;
            filterCategories('income');
        };

        function closeModal() {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target === modal) {
                closeModal();
            }
            if (event.target === categoryModal) {
                closeCategoryModal();
            }
        };

        document.getElementById("addCategoryForm").addEventListener("submit", function (event) {
            event.preventDefault();  // Prevent the form from submitting normally

            const formData = new FormData(this);  // Collect the form data
            const newCategoryType = formData.get('type');
            const categorySelect = document.getElementById('categorySelect'); // âœ… define this

            fetch("{% url 'add_category' %}", {
                method: "POST",
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.category_id && data.category_name) {
                        // âœ… Create and select the new option
                        const newOption = document.createElement('option');
                        newOption.value = data.category_id;
                        newOption.textContent = data.category_name;
                        newOption.dataset.type = newCategoryType;
                        newOption.selected = true;

                        categorySelect.appendChild(newOption);

                        // âœ… Set type radio button and filter
                        const radioToSelect = document.querySelector(`input[name="type"][value="${newCategoryType}"]`);
                        if (radioToSelect) {
                            radioToSelect.checked = true;
                            filterCategories(newCategoryType);
                        }

                        // âœ… Close modal
                        closeCategoryModal();
                    } else {
                        alert('Error creating category');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('There was an error creating the category');
                });
        });

        document.getElementById("addCategoryBtn").onclick = () => {
            categoryModal.style.display = "block";
        };

        // Close Category Modal
        function closeCategoryModal() {
            categoryModal.style.display = "none";
        }

        function filterCategories(selectedType) {
            let foundValidOption = false;

            Array.from(categorySelect.options).forEach(option => {
                if (option.dataset.type === selectedType) {
                    option.style.display = 'block';
                    if (!foundValidOption) {
                        foundValidOption = true;
                    }
                } else {
                    option.style.display = 'none';
                }
            });

            // Only reset selection if the selected option is no longer valid
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            if (!selectedOption || selectedOption.style.display === 'none') {
                categorySelect.selectedIndex = -1;
            }
        }

        typeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                filterCategories(radio.value);
            });
        });

        // Dropdown Profile Button Toggle (if needed)
        document.querySelector('.profile-btn')?.addEventListener('click', function () {
            const dropdown = document.querySelector('.dropdown-menu');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        window.addEventListener('click', function (e) {
            const profileBtn = document.querySelector('.profile-btn');
            const dropdown = document.querySelector('.dropdown-menu');
            if (profileBtn && dropdown && !profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
    </script>
</body>
{% endblock %}

</html>